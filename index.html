<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>Suivi des paris</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        /* ========= THEME ========= */
        :root {
            --bg: #f5f6f8;
            --card: #ffffff;
            --text: #111111;
            --muted: #6b7280;
            --accent: #16a34a;
            --border: #e5e7eb;
            --grid: #eeeeee;
        }

        [data-theme="dark"] {
            --bg: #0b0c0f;
            --card: #14161b;
            --text: #f3f4f6;
            --muted: #9ca3af;
            --accent: #22c55e;
            --border: #262a32;
            --grid: #1f232b;
        }

        /* ========= BASE ========= */
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: auto;
            padding: 1.5rem;
        }

        h1 {
            font-size: 1.7rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* ========= CARDS ========= */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
            margin-bottom: 2rem;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        label {
            font-size: 0.85rem;
            color: var(--muted);
        }

        input[type="number"] {
            padding: 0.45rem 0.7rem;
            font-size: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            width: 140px;
        }

        /* ========= TOGGLE ========= */
        .toggle {
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--muted);
        }

        /* ========= STATS ========= */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat {
            font-size: 0.9rem;
        }

        .stat b {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        /* ========= CHART ========= */
        .chart-wrapper {
            height: 280px;
        }

        /* ========= TABLE ========= */
        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            min-width: 600px;
        }

        th, td {
            padding: 0.85rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            text-align: left;
            font-weight: 500;
            color: var(--muted);
        }

        tr:hover {
            background: rgba(255,255,255,0.03);
        }

        /* ========= MOBILE ========= */
        @media (max-width: 768px) {
            h1 { font-size: 1.4rem; }
            .chart-wrapper { height: 220px; }
        }
    </style>
</head>

<body>
<div class="container">

    <h1>Suivi de mes paris</h1>

    <div class="card">
        <div class="row">
            <div>
                <label>Bankroll initiale (‚Ç¨)</label><br>
                <input type="number" id="bankrollInput" value="100" min="1" step="any">
            </div>
            <div class="toggle" id="themeToggle">üåô Dark mode</div>
        </div>

        <div class="stats" id="perfStats"></div>
    </div>

    <div class="card">
        <div class="row">
            <div class="chart-wrapper" style="flex:2; min-width:0;">
                <canvas id="performanceChart"></canvas>
            </div>
            <div style="flex:1; min-width:220px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:2rem;">
                <div style="width:210px;">
                    <canvas id="statusPieChart"></canvas>
                    <div id="pieStats" style="text-align:center; margin-top:0.5rem; font-size:0.95rem;"></div>
                </div>
                <div style="width:210px;">
                    <canvas id="sportPieChart"></canvas>
                    <div id="sportPieStats" style="text-align:center; margin-top:0.5rem; font-size:0.95rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 style="margin-top:0;font-size:1.1rem;">Historique</h2>
        <div class="table-wrapper">
            <table id="betsTable">
                <thead>
                <tr>
                    <th>Sport</th>
                    <th>Bookmaker</th>
                    <th>Date</th>
                    <th>√âv√©nement</th>
                    <th>R√©sultat</th>
                    <th>Cote</th>
                    <th>Mise</th>
                    <th>Gains</th>
                    <th>Bankroll</th>
                    <th>Gagn√© ?</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/1n30c7z0w0pjch9r6svRKohpPGMm1ePx9_KxhNgBkdCQ/export?format=csv&gid=786289597';
    const baseBankroll = 100;
    let chart, dataRows = [], pieChart, sportPieChart;

    const parseDate = s => {
        const m = s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})(?: (\d{1,2}):(\d{2}))?/);
        if (!m) return null;
        return new Date(m[3], m[2]-1, m[1], m[4]||0, m[5]||0);
    };

    fetch(sheetUrl)
        .then(r => r.text())
        .then(csv => {
            Papa.parse(csv, {
                skipEmptyLines: true,
                complete: res => {
                    dataRows = res.data.slice(6).filter(r => r[0]);
                    init();
                }
            });
        });

    function init() {
        chart = new Chart(performanceChart, {
            type: "line",
            data: { labels: [], datasets: [{
                    data: [],
                    borderWidth: 2,
                    tension: 0.35,
                    pointRadius: 0
                }]},
            options: chartOptions()
        });

        bankrollInput.addEventListener("input", update);
        update();
    }

    function update() {
        const mult = bankrollInput.value / baseBankroll;
        renderTable(mult);
        renderStats(mult);
        renderSportPieChart();
    }

    function renderTable(mult) {
        betsTable.querySelector("tbody").innerHTML = "";
        let bankrolls = [];
        let winCount = 0, loseCount = 0, pendingCount = 0;

        dataRows.forEach(r => {
            const eventDate = r[3]; // Date de l'√©v√®nement
            const gagne = (r[10] || "").toLowerCase();
            let gagneLabel = "en cours", gagneColor = "#a259e6";
            if (gagne === "oui") { gagneLabel = "oui"; gagneColor = "#22c55e"; winCount++; }
            else if (gagne === "non") { gagneLabel = "non"; gagneColor = "#ef4444"; loseCount++; }
            else { pendingCount++; }

            const gains = r[8] ? (parseFloat(r[8].replace(',', '.')) * mult).toFixed(2) : "0.00";
            const mise = r[9] ? (parseFloat(r[9].replace(',', '.')) * mult).toFixed(2) : "0.00";
            const bankroll = r[11] ? (parseFloat(r[11].replace(',', '.')) * mult).toFixed(2) : "0.00";
            bankrolls.push(bankroll);

            betsTable.querySelector("tbody").insertAdjacentHTML("beforeend", `
        <tr>
            <td>${r[0]}</td> <!-- Sport -->
            <td>${r[1]}</td> <!-- Bookmaker -->
            <td>${eventDate}</td>
            <td>${r[4]}</td> <!-- √âv√©nement -->
            <td>${r[5]}</td> <!-- R√©sultat -->
            <td>${r[6]}</td> <!-- Cote -->
            <td>${gains}‚Ç¨</td> <!-- Gains -->
            <td>${mise}‚Ç¨</td> <!-- Mise -->
            <td>${bankroll}‚Ç¨</td>
            <td><span style="color:${gagneColor};font-weight:600;">${gagneLabel}</span></td>
        </tr>
        `);
        });

        chart.data.labels = bankrolls.map((_,i)=>i+1);
        chart.data.datasets[0].data = bankrolls;
        chart.update();

        renderPieChart(winCount, loseCount, pendingCount);
    }


    function renderPieChart(win, lose, pending) {
        const total = win+lose+pending;
        const data = [win, lose, pending];
        const labels = ["Gagn√©", "Perdu", "En cours"];
        const colors = ["#22c55e", "#ef4444", "#a259e6"];
        if(!pieChart) {
            pieChart = new Chart(statusPieChart, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors }]
                },
                options: {
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') } }
                    }
                }
            });
        } else {
            pieChart.data.datasets[0].data = data;
            pieChart.update();
        }
        let html = '';
        [win, lose, pending].forEach((n,i) => {
            const pct = total ? (n/total*100).toFixed(1) : '0.0';
            html += `<span style="color:${colors[i]};font-weight:600;">${labels[i]}</span> : ${pct}% (${n})<br>`;
        });
        pieStats.innerHTML = html;
    }

    function renderSportPieChart() {
        // Compter les occurrences par sport
        const sportCounts = {};
        dataRows.forEach(r => {
            const sport = r[0] || "Inconnu";
            sportCounts[sport] = (sportCounts[sport] || 0) + 1;
        });
        const labels = Object.keys(sportCounts);
        const data = Object.values(sportCounts);
        const total = data.reduce((a, b) => a + b, 0);
        const colors = [
            "#22c55e", "#ef4444", "#a259e6", "#f59e42", "#3b82f6", "#eab308", "#10b981", "#6366f1"
        ];
        if (!sportPieChart) {
            sportPieChart = new Chart(sportPieChart, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') } }
                    }
                }
            });
        } else {
            sportPieChart.data.labels = labels;
            sportPieChart.data.datasets[0].data = data;
            sportPieChart.update();
        }
        // Affichage des stats
        let html = '';
        labels.forEach((sport, i) => {
            const pct = total ? (data[i] / total * 100).toFixed(1) : '0.0';
            html += `<span style="color:${colors[i % colors.length]};font-weight:600;">${sport}</span> : ${pct}% (${data[i]})<br>`;
        });
        sportPieStats.innerHTML = html;
    }

    function renderStats(mult) {
        const first = parseDate(dataRows[0][2]); // Date prise de paris
        const last = parseDate(dataRows[dataRows.length-1][2]); // Date de l'√©v√®nement
        const start = baseBankroll * mult;
        const end = parseFloat(dataRows[dataRows.length-1][11].replace(',', '.')) * mult;

        const perf = end - start;
        const pct = (end/start - 1) * 100;

        const days = (last-first)/86400000;
        const months = days / 30.4375;
        const years = days / 365.25;

        const ann = (Math.pow(end/start, 1/years)-1)*100;
        const mon = (Math.pow(end/start, 1/months)-1)*100;

        perfStats.innerHTML = `
    <div class="stat">
        <b>Performance</b>
        <span style="color:${perf>=0?'var(--accent)':'red'}">
            ${perf.toFixed(2)}‚Ç¨ (${pct.toFixed(2)}%)
        </span>
    </div>
    <div class="stat">
        <b>Annualis√©e</b>
        ${isFinite(ann)?ann.toFixed(2):'‚Äî'} %
    </div>
    <div class="stat">
        <b>Mensuelle</b>
        ${isFinite(mon)?mon.toFixed(2):'‚Äî'} %
    </div>
    <div class="stat">
        <b>Dur√©e</b>
        ${days.toFixed(0)} jours
    </div>
    `;
    }


    /* ========= THEME ========= */
    themeToggle.onclick = () => {
        const root = document.documentElement;
        const dark = root.dataset.theme === "dark";
        root.dataset.theme = dark ? "light" : "dark";
        themeToggle.textContent = dark ? "üåô Dark mode" : "‚òÄÔ∏è Light mode";
        chart.options = chartOptions();
        chart.update();
    };

    function chartOptions() {
        const s = getComputedStyle(document.documentElement);
        return {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: {
                    grid: { color: s.getPropertyValue('--grid') },
                    ticks: { color: s.getPropertyValue('--muted') }
                }
            },
            elements: {
                line: { borderColor: s.getPropertyValue('--accent') }
            }
        };
    }
</script>

</body>
</html>